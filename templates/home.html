<!-- templates/home.html -->
{% extends 'base.html' %}

{% block content %}
<h1>Grean Kingdom</h1>
<h2>Media Share - Add Video to Queue</h2>

<p>You have {{ remaining_duration }} seconds of submission time left.</p>

<form id="videoForm" method="post">
    <label for="youtube_url">YouTube URL:</label>
    <input type="text" id="youtube_url" name="youtube_url" required><br><br>

    <label for="start_min">Start Time:</label>
    <input type="number" id="start_min" name="start_min" min="0" value="0"> minutes
    <input type="number" id="start_sec" name="start_sec" min="0" max="59" value="0"> seconds<br><br>

    <label for="end_min">End Time:</label>
    <input type="number" id="end_min" name="end_min" min="0" value="0"> minutes
    <input type="number" id="end_sec" name="end_sec" min="0" max="59" value="0"> seconds<br><br>

    <button type="button" onclick="validateAndShowExample()" class="btn example-btn">Show Example</button>
    <button type="submit" id="submitButton" onclick="return validateForm()" class="btn submit-btn"
            {% if submissions_left == 0 or cooldown_left > 0 %}disabled{% endif %}>
        Send Video
    </button>
</form>

<p id="cooldownMessage" style="display: none;">Please wait <span id="cooldownTime"></span> seconds before submitting again.</p>

<div id="example"style="display: none;">
    <h3>Example:</h3>
    <p id="example-url"></p>
    <p id="example-start-time"></p>
    <p id="example-end-time"></p>
    <p id="example-duration"></p>
    <div class="example-video-container">
        <iframe id="example-video"
                src=""
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
        </iframe>
    </div>
</div>

<!-- Thai instructions -->
<div class="thai-instructions">
    <h2>คำแนะนำ (Instructions)</h2>
    <ol>
        <li>วางลิงก์วิดีโอ YouTube ในช่อง "YouTube URL"</li>
        <li>ระบุเวลาเริ่มต้นของคลิปที่ต้องการในช่อง "Start Time"</li>
        <li>ระบุเวลาสิ้นสุดของคลิปที่ต้องการในช่อง "End Time"</li>
        <li>คลิก "Show Example" เพื่อดูตัวอย่างคลิปที่เลือก</li>
        <li>หากพอใจกับตัวอย่าง ให้คลิก "Send Video" เพื่อส่งวิดีโอ</li>
        <li>โปรดทราบว่าความยาวของคลิปต้องไม่เกิน 3 นาที</li>
        <li>หากคุณส่งวิดีโอที่มีการจำกัดอายุ วิดีโอจะไม่สามารถเล่นได้และคุณจะเสียโควต้าการส่ง</li>
    </ol>
</div>


<script>
    function validateForm() {
        var startMin = parseInt(document.getElementById('start_min').value) || 0;
        var startSec = parseInt(document.getElementById('start_sec').value) || 0;
        var endMin = parseInt(document.getElementById('end_min').value) || 0;
        var endSec = parseInt(document.getElementById('end_sec').value) || 0;

        var startTime = startMin * 60 + startSec;
        var endTime = endMin * 60 + endSec;
        var duration = endTime - startTime;

        var remainingTime = {{ remaining_duration }};

        if (duration > remainingTime) {
            alert("Video duration (" + duration + " seconds) exceeds your remaining submission time (" + remainingTime + " seconds). Please choose a shorter clip.");
            return false;
        }

        if (startTime >= endTime) {
            alert("End time must be after start time.");
            return false;
        }

        if (duration > 180) {
            alert("Video clip cannot be longer than 3 minutes.");
            return false;
        }

        return true;
    }

    function validateAndShowExample() {
        if (validateForm()) {
            showExample();
        }
    }

    function showExample() {
        var youtubeUrl = document.getElementById('youtube_url').value;
        var startMin = parseInt(document.getElementById('start_min').value) || 0;
        var startSec = parseInt(document.getElementById('start_sec').value) || 0;
        var endMin = parseInt(document.getElementById('end_min').value) || 0;
        var endSec = parseInt(document.getElementById('end_sec').value) || 0;

        var videoId = extractVideoID(youtubeUrl);
        if (!videoId) {
            alert('Invalid YouTube URL');
            return;
        }

        var startTime = startMin * 60 + startSec;
        var endTime = endMin * 60 + endSec;

        document.getElementById('example-url').textContent = 'YouTube URL: ' + youtubeUrl;
        document.getElementById('example-start-time').textContent = 'Start Time: ' + startMin + ' minutes ' + startSec + ' seconds';
        document.getElementById('example-end-time').textContent = 'End Time: ' + endMin + ' minutes ' + endSec + ' seconds';
        document.getElementById('example-duration').textContent = 'Duration: ' + (endTime - startTime) + ' seconds';

        var embedUrl = 'https://www.youtube.com/embed/' + videoId + '?start=' + startTime + '&end=' + endTime;
        document.getElementById('example-video').src = embedUrl;

        document.getElementById('example').style.display = 'block';
    }

    function validateAndSubmit() {
        if (validateForm()) {
            document.getElementById('submitButton').disabled = true;
            setTimeout(function() {
                document.getElementById('submitButton').disabled = false;
            }, 5000);  // 5000 milliseconds = 5 seconds
            return true;
        }
        return false;
    }

    function extractVideoID(url) {
        // Regular expression for standard YouTube URLs and Shorts
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?)|(shorts\/))\??v?=?([^#&?]*).*/;
        var match = url.match(regExp);

        if (match && match[8] && match[8].length == 11) {
            return match[8];
        } else {
            // If no match found, check for the mobile short URL format
            var shortRegExp = /^.*youtube.com\/shorts\/([^#&?]*).*/;
            var shortMatch = url.match(shortRegExp);
            return (shortMatch && shortMatch[1].length == 11) ? shortMatch[1] : false;
        }
    }

    function updateCooldown() {
        var cooldownLeft = {{ cooldown_left }};
        var submitButton = document.getElementById('submitButton');
        var cooldownMessage = document.getElementById('cooldownMessage');
        var cooldownTime = document.getElementById('cooldownTime');

    function update() {
        if (cooldownLeft > 0) {
            submitButton.disabled = true;
            cooldownMessage.style.display = 'block';
            cooldownTime.textContent = cooldownLeft.toFixed(0);
            cooldownLeft--;
            setTimeout(update, 1000);
        } else {
            submitButton.disabled = false;
            cooldownMessage.style.display = 'none';
        }
    }

        update();
    }

    // Call this function when the page loads
    window.onload = updateCooldown;
</script>
{% endblock %}


